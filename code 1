from sqlalchemy import (
    Column,
    Integer,
    String,
    DateTime,
    Boolean,
    create_engine
)
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from sqlalchemy.sql import func
DATABASE_URL = "sqlite:///./chat.db"

engine = create_engine(
    DATABASE_URL,
    connect_args={"check_same_thread": False}
)




Base = declarative_base()



class Message(Base):
    __tablename__ = "messages"

    id = Column(Integer, primary_key=True, index=True)

    room_id = Column(String(255), index=True, nullable=False)

    sender_id = Column(String(255), index=True, nullable=False)

    content = Column(String(2000), nullable=False)

    timestamp = Column(
        DateTime(timezone=True),
        server_default=func.now()
    )

    is_read = Column(Boolean, default=False, nullable=False)

    def __repr__(self):
        return (
            f"<Message(id={self.id}, "
            f"room_id='{self.room_id}', "
            f"sender_id='{self.sender_id}', "
            f"is_read={self.is_read})>"
        )


Base.metadata.create_all(bind=engine)



SessionLocal = sessionmaker(
    autocommit=False,
    autoflush=False,
    bind=engine
)




def get_db():
    db = SessionLocal()
    try:
        return db
    finally:
        db.close()



def create_message(db, room_id, sender_id, content):
    message = Message(
        room_id=room_id,
        sender_id=sender_id,
        content=content
    )
    db.add(message)
    db.commit()
    db.refresh(message)
    return message


def get_messages_by_room(db, room_id):
    return (
        db.query(Message)
        .filter(Message.room_id == room_id)
        .order_by(Message.timestamp)
        .all()
    )


def get_unread_messages(db, room_id):
    return (
        db.query(Message)
        .filter(
            Message.room_id == room_id,
            Message.is_read == False
        )
        .all()
    )


def mark_message_as_read(db, message_id):
    message = db.query(Message).filter(Message.id == message_id).first()
    if message:
        message.is_read = True
        db.commit()
        db.refresh(message)
    return message


def delete_message(db, message_id):
    message = db.query(Message).filter(Message.id == message_id).first()
    if message:
        db.delete(message)
        db.commit()
    return message


if __name__ == "__main__":
    db = SessionLocal()


    msg1 = create_message(
        db,
        room_id="room_101",
        sender_id="user_1",
        content="Hello! This is my first message."
    )

    msg2 = create_message(
        db,
        room_id="room_101",
        sender_id="user_2",
        content="Hi! Welcome to the chat room."
    )


    print("All Messages:")
    messages = get_messages_by_room(db, "room_101")
    for msg in messages:
        print(msg)


    mark_message_as_read(db, msg1.id)


    print("\nUnread Messages:")
    unread = get_unread_messages(db, "room_101")
    for msg in unread:
        print(msg)

    db.close()
